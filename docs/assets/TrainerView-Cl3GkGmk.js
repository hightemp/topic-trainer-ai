import{c as h,d as P,l as G,r as d,m as J,p as K,a as o,f as s,F as M,b as S,u as v,j as A,x as I,g as b,q as O,t as c,i as W,k as X,v as Y,n as x,h as T,y as Z,o as l,_ as ee}from"./index-Zg22DbRy.js";import{a as te}from"./ai-DLb66c8R.js";import{a as V}from"./markdown-vDNTwY9N.js";import{v as se}from"./v4-EwEgHOG0.js";const ae=h("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);const $=h("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);const ne=h("circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const le=h("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const oe=h("list-tree",[["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"M3 10a2 2 0 0 0 2 2h3",key:"1npucw"}],["path",{d:"M3 5v12a2 2 0 0 0 2 2h3",key:"x1gjn2"}]]);const ie=h("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]]),re={class:"container"},ce={key:0,class:"setup-screen"},ue={class:"card mt-4"},de={class:"tags-cloud"},ve=["onClick"],pe={class:"card mt-4"},ye={class:"tags-cloud"},ke=["onClick"],me={class:"actions mt-4"},fe={key:1,class:"training-screen"},he={class:"progress-bar"},_e={class:"question-header"},ge={key:0,class:"timer"},we={class:"session-tree"},be={class:"status-icon"},xe={class:"q-info"},Ce={class:"q-cat"},Me={class:"q-text"},Se={key:1,class:"card question-card"},Te=["innerHTML"],ze={class:"answer-section mt-4"},De=["disabled"],Ae={class:"feedback-header"},Le={class:"score"},Fe={key:0,class:"correct-answer mt-4"},Ie=["innerHTML"],Ve={class:"actions mt-4"},$e=["disabled"],Ee={key:2,class:"result-screen"},qe={class:"card mt-4"},Be={class:"result-header"},Ne={class:"text-sm"},Qe=P({__name:"TrainerView",setup(Re){const y=G(),_=d("setup"),k=d(new Set),m=d(new Set),E=d(!0),u=d([]),i=d(0),f=d(""),g=d(!1),L=d(0),p=d(null),C=d(!1),z=d([]);J(async()=>{y.isLoaded||await y.loadData()});const q=K(()=>{const n=new Set;return y.questions.forEach(t=>t.tags.forEach(e=>n.add(e))),Array.from(n)});function B(n){k.value.has(n)?k.value.delete(n):k.value.add(n)}function N(n){m.value.has(n)?m.value.delete(n):m.value.add(n)}function Q(){const n=a=>{const r=y.categories.filter(w=>w.parentId===a);let D=r.map(w=>w.id);return r.forEach(w=>{D=[...D,...n(w.id)]}),D},t=new Set;k.value.forEach(a=>{t.add(a),n(a).forEach(r=>t.add(r))});let e=y.questions.filter(a=>!(k.value.size>0&&!t.has(a.categoryId)||m.value.size>0&&!a.tags.some(r=>m.value.has(r))));if(e.sort((a,r)=>a.nextReviewDate-r.nextReviewDate),u.value=e,u.value.length===0){alert("Нет вопросов, соответствующих критериям.");return}i.value=0,z.value=[],_.value="training",F()}function F(){f.value="",p.value=null,L.value=Date.now()}async function R(){if(!f.value.trim())return;g.value=!0;const n=u.value[i.value];if(!n)return;const t=(Date.now()-L.value)/1e3;try{const e=await te.evaluateAnswer(n.text,n.correctAnswer,f.value);p.value=e;const a=Math.round(e.score/2);H(n,a);const r={id:se(),questionId:n.id,date:Date.now(),userAnswer:f.value,aiScore:e.score,aiFeedback:e.feedback,duration:t};await Z.saveAttempt(r),z.value.push(r)}catch(e){console.error(e),alert("Ошибка проверки ответа")}finally{g.value=!1}}function H(n,t){let e=n.repetitionFactor,a=n.interval;t<3?a=1:(a===0?a=1:a===1?a=6:a=Math.round(a*e),e=e+(.1-(5-t)*(.08+(5-t)*.02)),e<1.3&&(e=1.3));const r=Date.now()+a*24*60*60*1e3;y.updateQuestion({...n,interval:a,repetitionFactor:e,nextReviewDate:r})}function j(){i.value<u.value.length-1?(i.value++,F()):_.value="result"}function U(n){const t=y.categories.find(e=>e.id===n);return t?t.name:"Unknown"}return(n,t)=>(l(),o("div",re,[_.value==="setup"?(l(),o("div",ce,[t[9]||(t[9]=s("h1",null,"Настройка тренировки",-1)),s("div",ue,[t[6]||(t[6]=s("h3",null,"Категории",-1)),s("div",de,[(l(!0),o(M,null,S(v(y).categories,e=>(l(),o("button",{key:e.id,class:x(["chip",{active:k.value.has(e.id)}]),onClick:a=>B(e.id)},c(e.name),11,ve))),128))])]),s("div",pe,[t[7]||(t[7]=s("h3",null,"Теги",-1)),s("div",ye,[(l(!0),o(M,null,S(q.value,e=>(l(),o("button",{key:e,class:x(["chip",{active:m.value.has(e)}]),onClick:a=>N(e)},c(e),11,ke))),128))])]),s("div",me,[s("button",{class:"primary large",onClick:Q},[A(v(ie),{size:24}),t[8]||(t[8]=I(" Начать ",-1))])])])):_.value==="training"?(l(),o("div",fe,[s("div",he,[s("div",{class:"progress-fill",style:O({width:`${(i.value+1)/u.value.length*100}%`})},null,4)]),s("div",_e,[s("span",null,"Вопрос "+c(i.value+1)+" из "+c(u.value.length),1),s("button",{class:"icon-btn",onClick:t[0]||(t[0]=e=>C.value=!0),title:"Показать дерево вопросов"},[A(v(oe),{size:16})]),E.value?(l(),o("span",ge,[A(v(le),{size:16}),t[10]||(t[10]=I(" ...",-1))])):b("",!0)]),C.value?(l(),o("div",{key:0,class:"modal-overlay",onClick:t[3]||(t[3]=e=>C.value=!1)},[s("div",{class:"modal-content",onClick:t[2]||(t[2]=W(()=>{},["stop"]))},[t[11]||(t[11]=s("h3",null,"Вопросы в сессии",-1)),s("ul",we,[(l(!0),o(M,null,S(u.value,(e,a)=>(l(),o("li",{key:e.id,class:x({active:a===i.value})},[s("span",be,[a<i.value?(l(),T(v($),{key:0,size:14,class:"text-success"})):(l(),T(v(ne),{key:1,size:14}))]),s("div",xe,[s("span",Ce,c(U(e.categoryId)),1),s("span",Me,c(e.text.substring(0,50))+"...",1)])],2))),128))]),s("button",{class:"primary mt-4",onClick:t[1]||(t[1]=e=>C.value=!1)},"Закрыть")])])):b("",!0),u.value[i.value]?(l(),o("div",Se,[s("div",{class:"markdown-body",innerHTML:v(V)(u.value[i.value]?.text||"")},null,8,Te)])):b("",!0),s("div",ze,[X(s("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>f.value=e),rows:"6",placeholder:"Ваш ответ...",disabled:!!p.value||g.value},null,8,De),[[Y,f.value]])]),p.value?(l(),o("div",{key:2,class:x(["feedback-section mt-4",p.value.score>=7?"good":"bad"])},[s("div",Ae,[p.value.score>=7?(l(),T(v($),{key:0,size:24})):(l(),T(v(ae),{key:1,size:24})),s("span",Le,"Оценка: "+c(p.value.score)+"/10",1)]),s("p",null,c(p.value.feedback),1),u.value[i.value]?(l(),o("div",Fe,[t[12]||(t[12]=s("strong",null,"Правильный ответ:",-1)),s("div",{innerHTML:v(V)(u.value[i.value]?.correctAnswer||"")},null,8,Ie)])):b("",!0)],2)):b("",!0),s("div",Ve,[p.value?(l(),o("button",{key:1,class:"primary",onClick:j},c(i.value<u.value.length-1?"Следующий вопрос":"Завершить"),1)):(l(),o("button",{key:0,class:"primary",onClick:R,disabled:g.value},c(g.value?"Проверка...":"Ответить"),9,$e))])])):(l(),o("div",Ee,[t[13]||(t[13]=s("h1",null,"Результаты тренировки",-1)),s("div",qe,[(l(!0),o(M,null,S(z.value,(e,a)=>(l(),o("div",{key:e.id,class:"result-item"},[s("div",Be,[s("strong",null,"Вопрос "+c(a+1),1),s("span",{class:x(e.aiScore>=7?"text-success":"text-danger")},c(e.aiScore)+"/10",3)]),s("p",Ne,c(e.aiFeedback),1)]))),128))]),s("button",{class:"primary mt-4",onClick:t[5]||(t[5]=e=>_.value="setup")},"Новая тренировка")]))]))}}),Ge=ee(Qe,[["__scopeId","data-v-e9906220"]]);export{Ge as default};
