import{c as m,d as P,l as G,r as d,m as J,p as K,a as o,f as s,F as M,b as S,u as y,i as A,x as V,g as b,q as O,t as c,w as W,k as X,v as Y,n as x,h as T,y as Z,o as l,_ as ee}from"./index-508QKKWx.js";import{a as te,d as se}from"./marked.esm-DcwHm8-5.js";import{v as ae}from"./v4-EwEgHOG0.js";const ne=m("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);const $=m("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);const le=m("circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const oe=m("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const ie=m("list-tree",[["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"M3 10a2 2 0 0 0 2 2h3",key:"1npucw"}],["path",{d:"M3 5v12a2 2 0 0 0 2 2h3",key:"x1gjn2"}]]);const re=m("play",[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]]),ce={class:"container"},ue={key:0,class:"setup-screen"},de={class:"card mt-4"},ve={class:"tags-cloud"},pe=["onClick"],ye={class:"card mt-4"},ke={class:"tags-cloud"},fe=["onClick"],he={class:"actions mt-4"},me={key:1,class:"training-screen"},_e={class:"progress-bar"},ge={class:"question-header"},we={key:0,class:"timer"},be={class:"session-tree"},xe={class:"status-icon"},Ce={class:"q-info"},Me={class:"q-cat"},Se={class:"q-text"},Te={key:1,class:"card question-card"},ze=["innerHTML"],De={class:"answer-section mt-4"},Ae=["disabled"],Le={class:"feedback-header"},Fe={class:"score"},Ie={key:0,class:"correct-answer mt-4"},Ve=["innerHTML"],$e={class:"actions mt-4"},Ee=["disabled"],qe={key:2,class:"result-screen"},Be={class:"card mt-4"},Ne={class:"result-header"},Qe={class:"text-sm"},Re=P({__name:"TrainerView",setup(He){const p=G(),_=d("setup"),k=d(new Set),f=d(new Set),E=d(!0),u=d([]),i=d(0),h=d(""),g=d(!1),L=d(0),v=d(null),C=d(!1),z=d([]);J(async()=>{p.isLoaded||await p.loadData()});const q=K(()=>{const a=new Set;return p.questions.forEach(t=>t.tags.forEach(e=>a.add(e))),Array.from(a)});function B(a){k.value.has(a)?k.value.delete(a):k.value.add(a)}function N(a){f.value.has(a)?f.value.delete(a):f.value.add(a)}function Q(){const a=n=>{const r=p.categories.filter(w=>w.parentId===n);let D=r.map(w=>w.id);return r.forEach(w=>{D=[...D,...a(w.id)]}),D},t=new Set;k.value.forEach(n=>{t.add(n),a(n).forEach(r=>t.add(r))});let e=p.questions.filter(n=>!(k.value.size>0&&!t.has(n.categoryId)||f.value.size>0&&!n.tags.some(r=>f.value.has(r))));if(e.sort((n,r)=>n.nextReviewDate-r.nextReviewDate),u.value=e,u.value.length===0){alert("Нет вопросов, соответствующих критериям.");return}i.value=0,z.value=[],_.value="training",F()}function F(){h.value="",v.value=null,L.value=Date.now()}async function R(){if(!h.value.trim())return;g.value=!0;const a=u.value[i.value];if(!a)return;const t=(Date.now()-L.value)/1e3;try{const e=await te.evaluateAnswer(a.text,a.correctAnswer,h.value);v.value=e;const n=Math.round(e.score/2);H(a,n);const r={id:ae(),questionId:a.id,date:Date.now(),userAnswer:h.value,aiScore:e.score,aiFeedback:e.feedback,duration:t};await Z.saveAttempt(r),z.value.push(r)}catch(e){console.error(e),alert("Ошибка проверки ответа")}finally{g.value=!1}}function H(a,t){let e=a.repetitionFactor,n=a.interval;t<3?n=1:(n===0?n=1:n===1?n=6:n=Math.round(n*e),e=e+(.1-(5-t)*(.08+(5-t)*.02)),e<1.3&&(e=1.3));const r=Date.now()+n*24*60*60*1e3;p.updateQuestion({...a,interval:n,repetitionFactor:e,nextReviewDate:r})}function U(){i.value<u.value.length-1?(i.value++,F()):_.value="result"}function I(a){return se(a||"")}function j(a){const t=p.categories.find(e=>e.id===a);return t?t.name:"Unknown"}return(a,t)=>(l(),o("div",ce,[_.value==="setup"?(l(),o("div",ue,[t[9]||(t[9]=s("h1",null,"Настройка тренировки",-1)),s("div",de,[t[6]||(t[6]=s("h3",null,"Категории",-1)),s("div",ve,[(l(!0),o(M,null,S(y(p).categories,e=>(l(),o("button",{key:e.id,class:x(["chip",{active:k.value.has(e.id)}]),onClick:n=>B(e.id)},c(e.name),11,pe))),128))])]),s("div",ye,[t[7]||(t[7]=s("h3",null,"Теги",-1)),s("div",ke,[(l(!0),o(M,null,S(q.value,e=>(l(),o("button",{key:e,class:x(["chip",{active:f.value.has(e)}]),onClick:n=>N(e)},c(e),11,fe))),128))])]),s("div",he,[s("button",{class:"primary large",onClick:Q},[A(y(re),{size:24}),t[8]||(t[8]=V(" Начать ",-1))])])])):_.value==="training"?(l(),o("div",me,[s("div",_e,[s("div",{class:"progress-fill",style:O({width:`${(i.value+1)/u.value.length*100}%`})},null,4)]),s("div",ge,[s("span",null,"Вопрос "+c(i.value+1)+" из "+c(u.value.length),1),s("button",{class:"icon-btn",onClick:t[0]||(t[0]=e=>C.value=!0),title:"Показать дерево вопросов"},[A(y(ie),{size:16})]),E.value?(l(),o("span",we,[A(y(oe),{size:16}),t[10]||(t[10]=V(" ...",-1))])):b("",!0)]),C.value?(l(),o("div",{key:0,class:"modal-overlay",onClick:t[3]||(t[3]=e=>C.value=!1)},[s("div",{class:"modal-content",onClick:t[2]||(t[2]=W(()=>{},["stop"]))},[t[11]||(t[11]=s("h3",null,"Вопросы в сессии",-1)),s("ul",be,[(l(!0),o(M,null,S(u.value,(e,n)=>(l(),o("li",{key:e.id,class:x({active:n===i.value})},[s("span",xe,[n<i.value?(l(),T(y($),{key:0,size:14,class:"text-success"})):(l(),T(y(le),{key:1,size:14}))]),s("div",Ce,[s("span",Me,c(j(e.categoryId)),1),s("span",Se,c(e.text.substring(0,50))+"...",1)])],2))),128))]),s("button",{class:"primary mt-4",onClick:t[1]||(t[1]=e=>C.value=!1)},"Закрыть")])])):b("",!0),u.value[i.value]?(l(),o("div",Te,[s("div",{class:"markdown-body",innerHTML:I(u.value[i.value]?.text||"")},null,8,ze)])):b("",!0),s("div",De,[X(s("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>h.value=e),rows:"6",placeholder:"Ваш ответ...",disabled:!!v.value||g.value},null,8,Ae),[[Y,h.value]])]),v.value?(l(),o("div",{key:2,class:x(["feedback-section mt-4",v.value.score>=7?"good":"bad"])},[s("div",Le,[v.value.score>=7?(l(),T(y($),{key:0,size:24})):(l(),T(y(ne),{key:1,size:24})),s("span",Fe,"Оценка: "+c(v.value.score)+"/10",1)]),s("p",null,c(v.value.feedback),1),u.value[i.value]?(l(),o("div",Ie,[t[12]||(t[12]=s("strong",null,"Правильный ответ:",-1)),s("div",{innerHTML:I(u.value[i.value]?.correctAnswer||"")},null,8,Ve)])):b("",!0)],2)):b("",!0),s("div",$e,[v.value?(l(),o("button",{key:1,class:"primary",onClick:U},c(i.value<u.value.length-1?"Следующий вопрос":"Завершить"),1)):(l(),o("button",{key:0,class:"primary",onClick:R,disabled:g.value},c(g.value?"Проверка...":"Ответить"),9,Ee))])])):(l(),o("div",qe,[t[13]||(t[13]=s("h1",null,"Результаты тренировки",-1)),s("div",Be,[(l(!0),o(M,null,S(z.value,(e,n)=>(l(),o("div",{key:e.id,class:"result-item"},[s("div",Ne,[s("strong",null,"Вопрос "+c(n+1),1),s("span",{class:x(e.aiScore>=7?"text-success":"text-danger")},c(e.aiScore)+"/10",3)]),s("p",Qe,c(e.aiFeedback),1)]))),128))]),s("button",{class:"primary mt-4",onClick:t[5]||(t[5]=e=>_.value="setup")},"Новая тренировка")]))]))}}),Ge=ee(Re,[["__scopeId","data-v-2beda789"]]);export{Ge as default};
